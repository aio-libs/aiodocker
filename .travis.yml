sudo: required

language: python

python:
  - "3.5"
  - "3.6"

env:
  - DOCKER_VERSION=17.03
  - DOCKER_VERSION=17.04
  - DOCKER_VERSION=17.05
  - DOCKER_VERSION=17.06

services:
  - docker

install:
  - docker run -d --privileged --net host --name ci-docker docker:$DOCKER_VERSION-dind dockerd -H tcp://localhost:27015
  - docker run -d --name registry -p 5000:5000 registry
  - docker run -d -p 5001:5001 --name registry2 -v `pwd`/tests/certs:/certs -e "REGISTRY_AUTH=htpasswd" -e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" -e REGISTRY_AUTH_HTPASSWD_PATH=/certs/htpasswd -e REGISTRY_HTTP_ADDR=0.0.0.0:5001 -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/registry.crt -e REGISTRY_HTTP_TLS_KEY=/certs/registry.key registry:2
  - pip install -r requirements/ci.txt

script:
  - python setup.py check -rms
  - DOCKER_HOST=tcp://localhost:27015 tox

after_success:
  - codecov

jobs:
  include:
    - stage: deploy
      python: 3.6
      deploy:
        provider: pypi
        user: barrachri
        password:
          secure: LYE8ZYhEgFILVyCeAjopvliBJEFsHqPbxcqZfQjTGH7kP0c1xFXFbvq+4jZHYLCxUpbtkGid7oZBgS4ju4DZz8kW9xPeGeac1D82WLQKFxN9dvxm4gsCBvdh4oARUV2e5qqjFeYQEimkPiFDtjN6rUFq+orrpbHzwp2geAHsqrmgo8dNSGEvqGKtJWDqnMr9d/p/zNGb4PDICNMzmobD/kGOz+jSdEye+ImWSPHDl8uygnUm3kuaY2QoFejSba9EkLmg76mfUvOt48HotbkoggYAqVsArSPLVGycmK+OkNXkfHkOQv0PnfAb70hhzh6VLHBrarOJOkFB9+ghkjD3qWWc6Uk9ozA25yLYuc/nXXe/BQeaTi6mBViSDa/+zWp9RrCyL84ZMHQ7ovL5q1WPJ3/2kWe2E7P+VFp/k7D4i7xlo2sajvowPv/atK9hLzgwnejpF+R0vrLjpPTcsTZKy/TfCt6wANFh/rlZg+QHIROXK1tnC6eQc/gUrXWt7CXd5UiAp129l7ngBstD9B1uBmf9wm2UaFBG3t6pWuzBl6ZXSvefbzxlhnFi5hHN3LWqs5vPI8kxOPyaDmcR06wjm56+st6s5m84wVYxxDBJ6lPZ66cXe5OIAj6PWyTOeFu14bQB2OD+zUMo/kXG5ToMFecd33yyXuh/Db/9K48uBTI=
        distributions: sdist bdist_wheel
        on:
          tags: true
          all_branches: true
