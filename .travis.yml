sudo: required

language: python

stages:
  - name: test
  - name: deploy
    if: tag IS present

# build matrix
python:
  - "3.5"
  - "3.6"

env:
  - DOCKER_VERSION=17.06

# test stage
services:
  - docker

install:
  - docker run -d --privileged --net host --name ci-docker docker:$DOCKER_VERSION-dind dockerd -H tcp://localhost:27015
  - docker run -d --name aiodocker-test-registry -p 5000:5000 registry:2
  - docker run -d -p 5001:5001 --name aiodocker-test-registry2 -v `pwd`/tests/certs:/certs -e "REGISTRY_AUTH=htpasswd" -e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" -e REGISTRY_AUTH_HTPASSWD_PATH=/certs/htpasswd -e REGISTRY_HTTP_ADDR=0.0.0.0:5001 -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/registry.crt -e REGISTRY_HTTP_TLS_KEY=/certs/registry.key registry:2
  - pip install -r requirements/ci.txt

script:
  - python setup.py check -rms
  - DOCKER_HOST=tcp://localhost:27015 tox

after_success:
  - codecov

# other stages
jobs:
  include:
    - stage: deploy
      python: 3.6
      deploy:
        provider: pypi
        user: barrachri
        password:
          secure: "X/vt2jFAbLIMLO9/oSxhd9NQu4gWN13RPD86jY/g0qkbO8VmqYLdqUzULWgwk4+6622L7SIOT1cQ98bvGlX6uYp3U8YW9/TYI4kZKFgQKu6ztzbNRkqmWaU6Vjx0gVOei3OqfK5LZEkuizVgqEi18DUkj6ifzdd2TYlhgfRTUxEIYRwUYatAlMJF09UIQTtd/eNswaqcVChvNBfpfejhfWnknZIyHefdIMoV5Q1j/vn2tFRkYoUEvE+H5Js6zLEezqG4ftYPm8T34bRmuaGo6YLzjPkTFmWYmHP0UO6Lnp6gjoHFh9Yfq3CCoLKfsZrjkKCbDFevUEDtR8GbPG27pQLG6kE88PmxMSaB6VbzmPNy4aVd/pC+d5lmJHBVAyYT9X+/L4D7SjgBIwmiHx/yiAVu1em46C1v8N4HlQE1/1gGh4y3AXOmjg5tyyeehsKmKpIKeieEdsrFBj3vPcJODG/3pVbqqyGh/VTlXSwW5gFRgnL3kpmiNxBGa0GWZDHtN6V6+268MJ5k+F04lNuFMRuXvcOgrfX4I6JQqcp/JuicN9tJGWhW81VS+yvzFtr3tANyJGpMUcE8dOmoFYpu+y5QO3TcsSzl8VdH8quPo0hou58XcQ+AgrM+WsOG2FYaVjcrF+W12FYDKQyEMIOqa/wCAv2dCGsuWvmNCaDimR4="
        distributions: sdist bdist_wheel
        on:
          tags: true
          all_branches: true
